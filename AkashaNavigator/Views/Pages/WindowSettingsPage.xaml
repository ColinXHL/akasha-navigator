<UserControl x:Class="AkashaNavigator.Views.Pages.WindowSettingsPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             Background="Transparent"
             Cursor="Arrow">

    <StackPanel>
            <!-- æ ‡é¢˜ -->
            <TextBlock Text="çª—å£è®¾ç½®" FontSize="18" FontWeight="SemiBold"
                       Foreground="White" Margin="0,0,0,16"/>

            <!-- çª—å£è¡Œä¸º -->
            <TextBlock Text="çª—å£è¡Œä¸º" Style="{StaticResource SettingsGroupHeaderStyle}"/>
            <CheckBox x:Name="EdgeSnapCheckBox" Content="å¯ç”¨è¾¹ç¼˜å¸é™„"
                      Style="{StaticResource DarkCheckBoxStyle}" Margin="0,0,0,12"
                      IsChecked="{Binding EnableEdgeSnap, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
            <Grid Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="100"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="45"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="å¸é™„é˜ˆå€¼" Style="{StaticResource SettingsLabelStyle}"/>
                <Slider x:Name="SnapThresholdSlider" Grid.Column="1"
                        Style="{StaticResource DarkSliderStyle}"
                        Minimum="5" Maximum="30" TickFrequency="5" IsSnapToTickEnabled="True"
                        Value="{Binding SnapThreshold, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                <TextBlock Grid.Column="2" Text="{Binding SnapThreshold, StringFormat={}{0}px}"
                           Style="{StaticResource SettingsLabelStyle}" HorizontalAlignment="Right"/>
            </Grid>
            <CheckBox x:Name="PromptRecordOnExitCheckBox" Content="é€€å‡ºæ—¶æç¤ºè®°å½•"
                      Style="{StaticResource DarkCheckBoxStyle}" Margin="0,0,0,12"
                      IsChecked="{Binding PromptRecordOnExit, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
            <TextBlock Text="å…³é—­çª—å£æ—¶æç¤ºè®°å½•å½“å‰æ¸¸æˆè¿›åº¦ç¬”è®°"
                       Foreground="#666" FontSize="11" Margin="0,0,0,24"/>

            <!-- é¼ æ ‡æ£€æµ‹ -->
            <TextBlock Text="é¼ æ ‡æ£€æµ‹" Style="{StaticResource SettingsGroupHeaderStyle}"/>
            <TextBlock Text="å½“å‰å°è¿›ç¨‹ä¸­å‡ºçŽ°é¼ æ ‡ï¼ˆå¦‚åŽŸç¥žæ‰“å¼€åœ°å›¾ï¼‰æ—¶è‡ªåŠ¨é™ä½Žæ’­æ”¾å™¨é€æ˜Žåº¦"
                       Foreground="#666" FontSize="11" Margin="0,0,0,12"/>

            <CheckBox x:Name="CursorDetectionEnabledCheckBox" Content="å¯ç”¨å…¨å±€é¼ æ ‡æ£€æµ‹"
                      Style="{StaticResource DarkCheckBoxStyle}" Margin="0,0,0,12"
                      IsChecked="{Binding CursorDetectionEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

            <!-- æœ€ä½Žé€æ˜Žåº¦æ»‘å— -->
            <Grid Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="100"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="45"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="æœ€ä½Žé€æ˜Žåº¦" Style="{StaticResource SettingsLabelStyle}"/>
                <Slider x:Name="CursorDetectionMinOpacitySlider" Grid.Column="1"
                        Style="{StaticResource DarkSliderStyle}"
                        Minimum="0.1" Maximum="0.8" TickFrequency="0.1" IsSnapToTickEnabled="True"
                        Value="{Binding CursorDetectionMinOpacity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                <TextBlock Grid.Column="2" Text="{Binding CursorDetectionMinOpacity, StringFormat={}{0:F1}}"
                           Style="{StaticResource SettingsLabelStyle}" HorizontalAlignment="Right"/>
            </Grid>

            <!-- æ£€æµ‹é—´éš”æ»‘å— -->
            <Grid Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="100"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="55"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="æ£€æµ‹é—´éš”" Style="{StaticResource SettingsLabelStyle}"/>
                <Slider x:Name="CursorDetectionCheckIntervalMsSlider" Grid.Column="1"
                        Style="{StaticResource DarkSliderStyle}"
                        Minimum="50" Maximum="500" TickFrequency="50" IsSnapToTickEnabled="True"
                        Value="{Binding CursorDetectionCheckIntervalMs, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                <TextBlock Grid.Column="2" Text="{Binding CursorDetectionCheckIntervalMs, StringFormat={}{0}ms}"
                           Style="{StaticResource SettingsLabelStyle}" HorizontalAlignment="Right"/>
            </Grid>

            <CheckBox x:Name="CursorDetectionEnableDebugLogCheckBox" Content="å¯ç”¨è°ƒè¯•æ—¥å¿—"
                      Style="{StaticResource DarkCheckBoxStyle}" Margin="0,0,0,12"
                      IsChecked="{Binding CursorDetectionEnableDebugLog, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

            <!-- è¿›ç¨‹ç™½åå• -->
            <TextBlock Text="è¿›ç¨‹ç™½åå•" Style="{StaticResource SettingsLabelStyle}" FontWeight="SemiBold" Margin="0,0,0,8"/>
            <TextBlock Text="æ·»åŠ éœ€è¦å¯ç”¨é¼ æ ‡æ£€æµ‹çš„æ¸¸æˆè¿›ç¨‹"
                       Foreground="#666" FontSize="11" Margin="0,0,0,8"/>

            <!-- æ·»åŠ è¿›ç¨‹ï¼šæ‰‹åŠ¨è¾“å…¥ + é€‰å–çª—å£æŒ‰é’® -->
            <Grid Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBox Grid.Column="0"
                         Style="{StaticResource DarkTextBoxStyle}"
                         Text="{Binding NewProcessName, UpdateSourceTrigger=PropertyChanged}"
                         Tag="è¾“å…¥è¿›ç¨‹åï¼ˆä¸å« .exeï¼‰"/>
                <Button Grid.Column="1" Content="æ·»åŠ " Style="{StaticResource PrimaryActionButtonStyle}"
                        Command="{Binding AddProcessCommand}"
                        Margin="4,0,0,0" Padding="12,6"/>
                <Button x:Name="SelectWindowButton" Grid.Column="2" Content="ðŸ“‹ é€‰å–çª—å£" 
                        Style="{StaticResource ActionButtonStyle}"
                        Click="SelectWindowButton_Click"
                        Margin="4,0,0,0" Padding="10,6"/>
                
                <!-- çª—å£é€‰æ‹© Popup -->
                <Popup x:Name="ProcessSelectorPopup"
                       PlacementTarget="{Binding ElementName=SelectWindowButton}"
                       Placement="Bottom"
                       StaysOpen="False"
                       AllowsTransparency="True"
                       PopupAnimation="Slide">
                    <Border Background="#2A2A2A" BorderBrush="#444" BorderThickness="1"
                            CornerRadius="4" Padding="4" MinWidth="280" MaxHeight="300">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- æ ‡é¢˜å’Œåˆ·æ–°æŒ‰é’® -->
                            <Grid Grid.Row="0" Margin="8,4,8,8">
                                <TextBlock Text="è¿è¡Œä¸­çš„çª—å£" Foreground="#AAA" FontSize="11"/>
                                <Button Content="ðŸ”„" Style="{StaticResource ActionButtonStyle}"
                                        Command="{Binding RefreshProcessListCommand}"
                                        HorizontalAlignment="Right"
                                        Padding="4,2" FontSize="10" ToolTip="åˆ·æ–°"/>
                            </Grid>
                            
                            <!-- è¿›ç¨‹åˆ—è¡¨ -->
                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" MaxHeight="250">
                                <ItemsControl ItemsSource="{Binding RunningProcesses}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Button Style="{StaticResource SearchResultButtonStyle}"
                                                    Command="{Binding DataContext.SelectProcessFromPopupCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"
                                                    HorizontalContentAlignment="Left"
                                                    Padding="8,6">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding ProcessName}" Foreground="White" FontWeight="SemiBold"/>
                                                    <TextBlock Text=" - " Foreground="#666"/>
                                                    <TextBlock Text="{Binding WindowTitle}" Foreground="#888" 
                                                               TextTrimming="CharacterEllipsis" MaxWidth="180"/>
                                                </StackPanel>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Popup>
            </Grid>

            <!-- å·²æ·»åŠ çš„ç™½åå•ï¼ˆTag æ ·å¼ï¼‰ -->
            <ItemsControl ItemsSource="{Binding ProcessWhitelist}" Margin="0,0,0,8">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="sys:String">
                        <Border Background="#333" CornerRadius="4" Padding="8,4" Margin="0,0,6,6">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding}" Foreground="White" FontSize="12" VerticalAlignment="Center"/>
                                <Button Content="âœ•" 
                                        Command="{Binding DataContext.RemoveProcessCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        Background="Transparent" Foreground="#888" BorderThickness="0"
                                        Padding="4,0,0,0" FontSize="10" Cursor="Hand"
                                        VerticalAlignment="Center">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <TextBlock Text="{TemplateBinding Content}" 
                                                                   Foreground="{TemplateBinding Foreground}"
                                                                   FontSize="{TemplateBinding FontSize}"
                                                                   Padding="{TemplateBinding Padding}"
                                                                   VerticalAlignment="Center"/>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Foreground" Value="#FF6B6B"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- ç©ºç™½åå•æç¤º -->
            <TextBlock Text="å°šæœªæ·»åŠ ä»»ä½•è¿›ç¨‹"
                       Foreground="#666" FontSize="11" Margin="0,0,0,0"
                       Visibility="{Binding ProcessWhitelist.Count, Converter={StaticResource ZeroToVisibleConverter}}"/>
        </StackPanel>
</UserControl>
